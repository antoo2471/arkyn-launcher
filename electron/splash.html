<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arkyn Launcher - Update</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #0d0d14; /* match splash window background */
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  font-family: "Outfit", sans-serif;
  color: #fff;
  overflow: hidden; /* pas de scrollbar */
}

/* Logo animé avec easing et pause naturelle */
.logo {
  width: 40%;  /* adapté à ta fenêtre 380px, ça fait ~150px */
  max-width: 160px;
  height: auto;
  animation: spinSmooth 2s cubic-bezier(0.65, 0, 0.35, 1) infinite;
}

.logo.paused {
  animation-play-state: paused;
}

@keyframes spinSmooth {
  0% { transform: rotate(0deg); }
  70% { transform: rotate(360deg); }
  100% { transform: rotate(360deg); }
}

/* Texte de chargement */
.loader-text {
  margin-top: 5%;
  font-size: 1.2rem;  /* lisible sur la fenêtre petite */
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.sub-text {
  margin-top: 8px;
  color: #b6b8c9;
  font-size: 0.9rem;
  min-height: 18px;
  text-align: center;
  padding: 0 20px;
}

.version-text {
  margin-top: 6px;
  color: #a99bff;
  font-size: 0.82rem;
  min-height: 16px;
}

/* Points animés */
.dots span {
  display: inline-block;
  font-size: 1.2rem;
  animation: blink 1s infinite;
}

.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { opacity: 0; }
  40% { opacity: 1; }
}

.progress-wrap {
  width: 78%;
  margin-top: 16px;
  display: none;
}

.progress-wrap.show {
  display: block;
}

.progress-text {
  font-size: 0.86rem;
  font-weight: 700;
  margin-bottom: 6px;
}

.progress-track {
  width: 100%;
  height: 10px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.14);
  overflow: hidden;
}

.progress-fill {
  width: 0%;
  height: 100%;
  background: linear-gradient(90deg, #4904eb, #8a74ff);
  transition: width 0.2s ease;
}

.actions {
  margin-top: 16px;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

button {
  display: none;
  height: 36px;
  border: none;
  border-radius: 10px;
  padding: 0 14px;
  font-size: 0.86rem;
  font-weight: 700;
  color: #fff;
  cursor: pointer;
}

button.show {
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

#downloadBtn, #installBtn {
  background: #4904eb;
}

#retryBtn {
  background: #e63946;
}
</style>
</head>
<body>

<img src="../icon.png" alt="logo" class="logo" id="logo">

<div class="loader-text">
  Recherche de mises a jour
  <div class="dots" id="dots">
    <span>.</span><span>.</span><span>.</span>
  </div>
</div>

<div class="sub-text" id="message">Verification en cours...</div>
<div class="version-text" id="version"></div>

<div class="progress-wrap" id="progressWrap">
  <div class="progress-text" id="progressText">0%</div>
  <div class="progress-track">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<div class="actions">
  <button id="downloadBtn">Telecharger la mise a jour</button>
  <button id="installBtn">Redemarrer et installer</button>
  <button id="retryBtn">Reessayer</button>
</div>

<script>
const ipc = window.electron?.ipcRenderer;
const logo = document.getElementById('logo');
const dots = document.getElementById('dots');
const message = document.getElementById('message');
const version = document.getElementById('version');
const progressWrap = document.getElementById('progressWrap');
const progressText = document.getElementById('progressText');
const progressFill = document.getElementById('progressFill');
const downloadBtn = document.getElementById('downloadBtn');
const installBtn = document.getElementById('installBtn');
const retryBtn = document.getElementById('retryBtn');

function toggleButton(button, visible) {
  button.classList.toggle('show', visible);
}

function renderUpdaterState(state = {}) {
  const status = state.status || 'checking';
  const text = state.message || 'Verification en cours...';
  const latestVersion = state.latestVersion || '';
  const progress = Math.max(0, Math.min(100, Math.round(state.progressPercent || 0)));

  message.textContent = text;
  version.textContent = latestVersion ? `Nouvelle version: ${latestVersion}` : '';
  progressText.textContent = `${progress}%`;
  progressFill.style.width = `${progress}%`;

  const activeSpin = status === 'checking' || status === 'idle' || status === 'downloading';
  logo.classList.toggle('paused', !activeSpin);
  dots.style.visibility = activeSpin ? 'visible' : 'hidden';

  progressWrap.classList.toggle('show', status === 'downloading');
  toggleButton(downloadBtn, status === 'available');
  toggleButton(installBtn, status === 'downloaded');
  toggleButton(retryBtn, status === 'error');
}

downloadBtn.addEventListener('click', () => {
  ipc?.invoke('updater-download');
});

installBtn.addEventListener('click', () => {
  ipc?.invoke('updater-install');
});

retryBtn.addEventListener('click', () => {
  ipc?.invoke('updater-check');
});

ipc?.on('updater-state', (_, state) => renderUpdaterState(state));
ipc?.invoke('updater-get-state').then((state) => renderUpdaterState(state));
</script>

</body>
</html>
